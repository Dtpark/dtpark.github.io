# æ“ä½œç³»ç»Ÿç¬”è®°

## ä¸€ã€Hello, World â€œæœ€å°â€ç¨‹åº

### 1.1 å‰ç½®çŸ¥è¯†

- gdb å°çŸ¥è¯†ç‚¹

  - `layout asm`ï¼šæ±‡ç¼–æ¨¡å¼è°ƒè¯•
  - `layout src`ï¼šæºç è§†è§’è°ƒè¯•
  - `starti`ï¼šæ‰§è¡Œç¬¬ä¸€æ¡æŒ‡ä»¤å°±åœä¸‹æ¥

- objdumpâ€”â€”display information from object files.

  - gcc ç¼–è¯‘æ—¶åŠ å…¥å‚æ•° `-g`ï¼Œåˆ™ä¼šå°†æºç ä¿¡æ¯æ‰“åŒ…è¿›äºŒè¿›åˆ¶æ–‡ä»¶ä¸­

  - objdump -S æŸ¥çœ‹ a.out ä»£ç ä¼šçœ‹åˆ°æºç ä¿¡æ¯

  - > `syscall@plt`ï¼šè¡¨ç¤ºåŠ¨æ€é“¾æ¥

- `tldr [command]`ï¼šæŸ¥çœ‹æ‰‹å†Œï¼ˆæ¯” man ç®€å•æ˜“ç”¨ï¼‰ 

- çŠ¶æ€æœº

  - çŠ¶æ€ = å¯„å­˜å™¨ä¿å­˜çš„å€¼ï¼ˆflip-flopï¼‰
  - åˆå§‹çŠ¶æ€ = RESET(implementation dependent)
  - è¿ç§» = ç»„åˆé€»è¾‘ç”µè·¯è®¡ç®—å¯„å­˜å™¨ä¸‹ä¸€å‘¨æœŸçš„å€¼

- gcc

  - -E ï¼šä¼šå°†æ‰€æœ‰çš„å®å±•å¼€
  - `-static`ï¼š~~ä¸ä¾èµ–ä»»ä½•åŠ¨æ€é“¾æ¥åº“~~
  - `--verbose`
  - `-c`ï¼šcompile onlyï¼Œåªæ˜¯å•çº¯ç¼–è¯‘
  
- ld é“¾æ¥ <*.o>

- shell

  - `./a.out | head -n [number] | sort | uniq -c `
    - headï¼šè¾“å‡º number æ¬¡ç»“æœ
    - sortï¼šæ’åº
    - uniq -cï¼šç»Ÿè®¡ç»“æœå‡ºç°çš„æ¬¡æ•°
  
- head -n /<num> å–å¤šå°‘ä¸ªæ•°æ®

- sort æŒ‰è¡Œæ’åº

- uniq -c ç»Ÿè®¡é¢‘ç‡

### 1.2 ä¸€ä¸ªæ™®é€š çš„ C ç¨‹åºæ‰§è¡Œçš„ç¬¬ä¸€æ¡æŒ‡ä»¤åœ¨å“ªé‡Œï¼Ÿ

- main çš„ç¬¬ä¸€æ¡æŒ‡ä»¤ï¼ˆâŒï¼‰

- libc çš„ _startï¼ˆâŒï¼‰

- ```bash
  gdb a.out
  ...
  (gdb) start i
  Starting program /tmp/demo/a.out
  
  Program stopped.
  0x00007ffff7fd0100 in _start () from /lib64/ld-linux-x86-64.so.2
  
  (gdb) !pmap 407033
  407033:   /tmp/a.out
  0000555555554000      4K r---- a.out
  0000555555555000      4K r-x-- a.out
  0000555555556000      4K r---- a.out
  0000555555557000      8K rw--- a.out
  00007ffff7fcb000     12K r----   [ anon ]
  00007ffff7fce000      4K r-x--   [ anon ]
  00007ffff7fcf000      4K r---- ld-2.31.so
  00007ffff7fd0000    140K r-x-- ld-2.31.so
  00007ffff7ff3000     32K r---- ld-2.31.so
  00007ffff7ffc000      8K rw--- ld-2.31.so
  00007ffff7ffe000      4K rw---   [ anon ]
  00007ffffffde000    132K rw---   [ stack ]
  ffffffffff600000      4K --x--   [ anon ]
   total              360K
  ```
  
- `info registers`ï¼šæŸ¥çœ‹å¯„å­˜å™¨ä¿¡æ¯

- `info inferiors`ï¼šæŸ¥çœ‹è¿›ç¨‹ä¿¡æ¯

- `!` å¯ä»¥æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚å¦‚ï¼Œ`!ls` ã€`!pmap [pid](æˆ– cat /proc/[pid]/maps)`ç­‰
- ã€ç­”æ¡ˆã€‘è¿›ç¨‹åˆå§‹æ—¶åˆ° main() æ‰§è¡Œæ—¶ï¼Œè¿›ç¨‹çš„å†…å­˜ä¸­å¤šäº† `libc-2.27.so`
  - `ld-linux-x86-64.so`åŠ è½½äº† `libc`ï¼ˆâœ…ï¼‰
  - ä¹‹å `libc`å®Œæˆäº†è‡ªå·±çš„åˆå§‹åŒ–
    - `main`çš„å¼€å§‹/ç»“æŸå¹¶ä¸æ˜¯æ•´ä¸ªç¨‹åºçš„å¼€å§‹/ç»“æŸ

- Trace (è¿½è¸ªç¨‹åºä»å¼€å§‹åˆ°ç»“æŸæ‰€æœ‰äº‹æƒ…)
  - **strace**ï¼šå¾ˆé‡è¦çš„å·¥å…·â€”â€”trace system calls and signalsï¼ˆæ‰“å°ç³»ç»Ÿè°ƒç”¨å’Œä¿¡å·ï¼‰
  - `strace [file name] > /dev/null`ï¼š/dev/null æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„è®¾å¤‡æ–‡ä»¶ï¼Œæ‰€æœ‰å†™å…¥çš„æ•°æ®å°†ç›´æ¥è¢«ä¸¢å¼ƒ

### 1.3 å°ç»“ï¼šæœ¬è´¨ä¸Šï¼Œæ‰€æœ‰çš„ç¨‹åºå’Œ Hello World ç±»ä¼¼

- è¢«æ“ä½œç³»ç»ŸåŠ è½½

  - é€šè¿‡çˆ¶è¿›ç¨‹çš„ `execve`

- ä¸æ–­æ‰§è¡Œç³»ç»Ÿè°ƒç”¨

  - è¿›ç¨‹ç®¡ç† ï¼š`fork, execve, exit, ...`
  - æ–‡ä»¶/è®¾å¤‡ç®¡ç†ï¼š`open, close, read, write, ...`
  - å­˜å‚¨ç®¡ç†ï¼š `mmap, brk, ...`

- ç›´åˆ° `_exit(exit_group)` é€€å‡ºã€‚

  >  exit_group ä¼šé€€å‡ºè¿›ç¨‹çš„æ‰€æœ‰çº¿ç¨‹

` .c->(preprocess)-> .i -> (compile) -> .s -> (assembly) -> .o -> (link) -> a.out`

---

### 1.4 æ›´å¤šçš„ Demos

#### 1. ç¼–è¯‘å™¨ï¼ˆgccï¼‰

`strace -f gcc hello-goodbye.c 2>&1 | grep execve`

> - -fï¼šä»å­è¿›ç¨‹åˆ›å»ºå°±å¼€å§‹è¿½è¸ª
>
> - 2>&1ï¼šå°†é”™è¯¯è¾“å‡ºé‡å®šå‘åˆ°ä¸€ä¸ªæ ‡å‡†è¾“å‡º

- ä¸»è¦çš„ç³»ç»Ÿè°ƒç”¨ï¼š `execve, read, write`
- æ‰§è¡Œç¨‹åºï¼š
  - `ccl` - ç¼–è¯‘å™¨ï¼ˆc->æ±‡ç¼–ï¼‰
  - `as` - æ±‡ç¼–å™¨ï¼ˆæ±‡ç¼–-> ELF relocatableï¼‰
  - `collect2` - æ”¶é›†å™¨ï¼ˆæ”¶é›†æ„é€ å‡½æ•°ä¿¡æ¯ï¼Œå¹¶ç”Ÿæˆä»£ç ï¼‰
  - `ld` - é“¾æ¥

#### 2. å›¾å½¢ç•Œé¢ç¨‹åºï¼ˆxeditï¼‰

`strace xedit`

- ä¸»è¦çš„ç³»ç»Ÿè°ƒç”¨ï¼š`poll, recvmsg, write`
- å›¾å½¢ç•Œé¢ç¨‹åºå’Œ X-Window Server æŒ‰ç…§ X11 åè®®é€šä¿¡
- è™šæ‹Ÿæœºä¸­çš„ xedit å°† X11 å‘½ä»¤é€šè¿‡ ssh (X11 forwarding) è½¬å‘åˆ° Host

#### 3.å…¶ä»–åº”ç”¨ç¨‹åº

éƒ½æ˜¯åœ¨è¿™éå¸¸ç²¾ç®€çš„ä¸€å¥—æ“ä½œç³»ç»Ÿ API ä¸Šæ„å»ºçš„ã€‚

- çª—å£ç®¡ç†å™¨ï¼šç®¡ç†è®¾å¤‡å’Œå±å¹•ï¼ˆ`read/write/mmap`)ï¼›è¿›ç¨‹é—´é€šä¿¡ï¼ˆ`send, recv`ï¼‰
- ä»»åŠ¡ç®¡ç†å™¨ï¼šè®¿é—®æ“ä½œç³»ç»Ÿæä¾›çš„è¿›ç¨‹å¯¹è±¡(`readdir/read`)
- æ€æ¯’è½¯ä»¶ï¼šæ–‡ä»¶é™æ€æ‰«æï¼ˆ`read`ï¼‰ï¼›åŠ¨æ€é˜²å¾¡ï¼ˆ`ptrace`ï¼‰

## äºŒã€å¤šå¤„ç†å™¨ç¼–ç¨‹ï¼šä»å…¥é—¨åˆ°æ”¾å¼ƒï¼ˆå¹¶å‘ï¼‰

### 1. å¹¶å‘ï¼ˆConcurrencyï¼‰ä¸å¹¶è¡Œï¼ˆParalleliï¼‰

> **å¹¶å‘** concurrency refers to the ability of different parts or units of a program, algorithm, or problem to be executed out-of-order or in partial order, without affecting the final outcome. 

ä¸ºä»€ä¹ˆè¿™é—¨è¯¾è®²å¹¶å‘ï¼Ÿ

- è®²å¹¶å‘
  - æ“ä½œç³»ç»Ÿæ˜¯æœ€æ—©çš„å¹¶å‘ç¨‹åºä¹‹ä¸€
  - å¹¶å‘æ§åˆ¶ç®—æ³•æœ€æ—©åœ¨æ“ä½œç³»ç»Ÿä¸­ç ”ç©¶

- å…¸å‹çš„å¹¶å‘ç³»ç»Ÿ
  - **å¹¶å‘**ï¼šå¤šä¸ªæ‰§è¡Œæµå¯ä»¥ä¸æŒ‰ç…§ä¸€ä¸ªç‰¹å®šé¡ºåºæ‰§è¡Œ
  - **å¹¶è¡Œ**ï¼šå…è®¸å¤šä¸ªæ‰§è¡ŒæµåŒæ—¶æ‰§è¡Œï¼ˆå¤šä¸ªå¤„ç†å™¨ï¼‰

| å¤„ç†å™¨æ•°é‡   | å…±äº«å†…å­˜ï¼Ÿ   | å…¸å‹çš„å¹¶å‘ç³»ç»Ÿ                | å¹¶å‘/å¹¶è¡Œ  |
| ------------ | ------------ | ----------------------------- | ---------- |
| å•å¤„ç†å™¨     | å…±äº«å†…å­˜     | OS å†…æ ¸/å¤šçº¿ç¨‹ç¨‹åº            | å¹¶å‘ä¸å¹¶è¡Œ |
| **å¤šå¤„ç†å™¨** | **å…±äº«å†…å­˜** | OS å†…æ ¸/å¤šçº¿ç¨‹ç¨‹åº/GPU Kernel | å¹¶å‘ã€å¹¶è¡Œ |
| å¤šå¤„ç†å™¨     | ä¸å…±äº«å†…å­˜   | åˆ†å¸ƒå¼ç³»ç»Ÿï¼ˆæ¶ˆæ¯é€šä¿¡ï¼‰        | å¹¶å‘ã€å¹¶è¡Œ |

### 2. çº¿ç¨‹

- å¤šä¸ªæ‰§è¡Œæµå¹¶å‘/å¹¶è¡Œæ‰§è¡Œï¼Œå¹¶ä¸”å®ƒä»¬**å…±äº«å†…å­˜**

  - ä¸¤ä¸ªæ‰§è¡Œæµå…±äº«ä»£ç å’Œæ‰€æœ‰å…¨å±€å˜é‡ï¼ˆæ•°æ®ã€å †åŒºï¼‰
  - çº¿ç¨‹ä¹‹é—´æŒ‡ä»¤çš„æ‰§è¡Œé¡ºåºæ˜¯ä¸ç¡®å®šçš„ï¼ˆnon-deterministicï¼‰çš„

  ```c
  int x = 0, y = 0; // defaults to 0
  
  void thread_1() {
    x = 1;  // 1
    printf("y = %d\n", y);  // 2
  }
  
  void thread_2() {
    y = 1;  // 3
    printf("x = %d\n", x);  // 4
  }
  ```

  - 1 -> 2 -> 3 -> 4 (y=0, x=1)
  - 1 -> 3 -> 2 -> 4 (y=1, x=1)
  - 1 -> 3 -> 4 -> 2 (x=1, y=1)
  - ...

- ä»€ä¹ˆè¯¥å…±äº«ï¼Œä»€ä¹ˆä¸å…±äº«ï¼Ÿ

- ç°ä»£å¤„ç†å™¨ä¹Ÿæ˜¯ï¼ˆåŠ¨æ€ï¼‰ç¼–è¯‘å™¨ï¼ˆ~~æ±‡ç¼–ä¼šè¢«ç¿»è¯‘æˆå¾®æŒ‡ä»¤~~ï¼‰ï¼Œå¯ä»¥å¹¶è¡Œæ‰§è¡Œå¤šæ¡æŒ‡ä»¤ï¼ˆç»´æŠ¤ä¸€ä¸ªæŒ‡ä»¤çš„æœ‰å‘æ— ç¯å›¾ï¼Œå¯ä»¥å–å¤šæ¡æŒ‡ä»¤åŒæ—¶æ‰§è¡Œå¤šè·¯å‘å°„ï¼‰

  - å¤šå¤„ç†å™¨é—´å³æ—¶å¯è§æ€§çš„ä¸§å¤±ï¼ˆcache missï¼Œæ²¡æœ‰ä¸€è‡´æ€§ ï¼‰

### 3. æ€»ç»“

æœ¬æ¬¡è¯¾ç¨‹å›ç­”çš„é—®é¢˜ï¼šå¦‚ä½•ç†è§£å¤šå¤„ç†å™¨ç³»ç»Ÿï¼Ÿ

Take- away message

- å¤šå¤„ç†å™¨ç¼–ç¨‹ï¼šå…¥é—¨
  - å¤šå¤„ç†å™¨ç¨‹åº = çŠ¶æ€æï¼ˆå…±äº«å†…å­˜ï¼›éç¡®å®šé€‰æ‹©çº¿ç¨‹æ‰§è¡Œï¼‰
  - thread.h = create + join
- å¤šå¤„ç†å™¨ç¼–ç¨‹ï¼šæ”¾å¼ƒå¯¹â€œç¨‹åºâ€çš„æ—§ç†è§£
  - ä¸åŸå­ã€èƒ½ä¹±åºã€ä¸ç«‹å³å¯è§
    - æ¥è‡ªäºç¼–è¯‘ä¼˜åŒ–ï¼ˆå¤„ç†å™¨ä¹Ÿæ˜¯ç¼–è¯‘å™¨ï¼‰
    - Ad hoc synchronization considered harmful(OSDL'10)

## ä¸‰ã€ç†è§£å¹¶å‘ç¨‹åºæ‰§è¡Œ

- **äº’æ–¥**ï¼šä¿è¯ä¸¤ä¸ªçº¿ç¨‹ä¸èƒ½åŒæ—¶æ‰§è¡Œä¸€æ®µä»£ç ã€‚

> æ­£ç¡®æ€§ä¸æ˜çš„å¥‡æ€ªå°è¯•ï¼ˆPeterson ç®—æ³•ï¼‰ï¼š
>
> A å’Œ B äº‰ç”¨å•æ‰€çš„åŒ…å¢
>
> - æƒ³è¿›å…¥åŒ…å¢ä¹‹å‰
>   - A ç¡®è®¤æ——å­ä¸¾å¥½ä»¥åï¼Œå¾€å•æ‰€é—¨ä¸Šè´´ä¸Šâ€œBæ­£åœ¨ä½¿ç”¨â€çš„æ ‡ç­¾
>   - B ç¡®è®¤æ——å­ä¸¾å¥½ä»¥åï¼Œå¾€å•æ‰€é—¨ä¸Šè´´ä¸Šâ€œA æ­£åœ¨ä½¿ç”¨â€çš„æ ‡ç­¾
> - ç„¶åï¼Œ*å¦‚æœå¯¹æ–¹çš„æ——å­ä¸¾èµ·æ¥ï¼Œä¸”é—¨ä¸Šçš„åå­—ä¸æ˜¯è‡ªå·±*ï¼Œç­‰å¾…
>   - å¦åˆ™å¯ä»¥è¿›å…¥åŒ…å¢
> - å‡ºåŒ…å¢åï¼Œæ”¾ä¸‹è‡ªå·±çš„æ——å­
>
> è¿›å…¥ä¸´ç•ŒåŒºçš„æƒ…å†µ
>
> - å¦‚æœåªæœ‰ä¸€ä¸ªäººä¸¾æ——ï¼Œä»–å°±å¯ä»¥ç›´æ¥è¿›å…¥
> - å¦‚æœä¸¤ä¸ªäººåŒæ—¶ä¸¾èµ·æ——ï¼Œç”±å•æ‰€é—¨ä¸Šçš„æ ‡ç­¾å†³å®šè°è¿›
>   - æ‰‹å¿«ğŸˆ¶ï¸ï¼ˆè¢«å¦ä¸€ä¸ªäººçš„æ ‡ç­¾è¦†ç›–ï¼‰ã€æ‰‹æ…¢ğŸˆšï¸
>
> ä¸€äº›å…·ä½“çš„ç»†èŠ‚æƒ…å†µã€çœ‹çœ‹ã€‘ 
>
> - Açœ‹åˆ° B æ²¡æœ‰ä¸¾æ£‹
>   - B ä¸€å®šä¸åœ¨ä¸´ç•ŒåŒº
>   - æˆ–è€… B æƒ³è¿›ä½†æ²¡æ¥å¾—åŠæŠŠ â€œA æ­£åœ¨ä½¿ç”¨â€ è´´åœ¨é—¨ä¸Š
>     - memory ordering
> - A çœ‹åˆ° B ä¸¾æ——å­
>   - A ä¸€å®šå·²ç»æŠŠæ——å­ä¸¾èµ·æ¥äº†â€¦â€¦

